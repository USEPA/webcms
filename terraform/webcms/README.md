# WebCMS Application Deployment Templates

## Table of Contents

- [Table of Contents](#table-of-contents)
- [About](#about)
- [Prerequisites](#prerequisites)
  - [Infrastructure](#infrastructure)
  - [Database](#database)
  - [Terraform Backend](#terraform-backend)
  - [Built Images](#built-images)
- [Module Inputs](#module-inputs)
  - [Variables](#variables)
    - [Provider Variables](#provider-variables)
    - [Deployment Variables](#deployment-variables)
    - [Drupal Variables](#drupal-variables)
      - [The `drupal_state` Variable](#the-drupal_state-variable)
      - [Sensitive Values](#sensitive-values)
    - [Email Variables](#email-variables)
      - [Sensitive Values](#sensitive-values-1)
    - [SAML Variables](#saml-variables)
      - [Sensitive Values](#sensitive-values-2)
  - [Parameter Store](#parameter-store)
- [Resources](#resources)
  - [Drupal](#drupal)
  - [Drush](#drush)
  - [Routing](#routing)
- [Module Outputs](#module-outputs)
- [How to Run](#how-to-run)
  - [Build Images](#build-images)
  - [Apply Terraform](#apply-terraform)
  - [Drush Updates](#drush-updates)
- [Post-Run Steps](#post-run-steps)
  - [DNS](#dns)
  - [Site Installation](#site-installation)
  - [Changing `drupal_state`](#changing-drupal_state)
- [Known Issues](#known-issues)

## About

This directory contains a Terraform module for deploying the WebCMS to a pre-configured AWS environment containing AWS services and an ECS cluster.

The module arranges for an ECS service deployment using custom-built Docker images. Drupal and nginx are placed into an autoscaling service with CPU-based autoscaling rules to supply elastic capacity. EventBridge runs Drush every five minutes, dispatching workflow rules and other scheduled updates.

## Prerequisites

Because this module deploys to pre-existing infrastructure, a number of prerequisites must be met.

### Infrastructure

The infrastructure module in [terraform/infrastructure](../infrastructure) needs to have been deployed. Please see that module and its [README](../infrastructure/README.md) for prerequisites and instructions.

### Database

Drupal cannot install to an empty database. We recommend the usage of the database module in [terraform/database](../database) to initialize usernames and passwords for a Drupal installation. Please see that module's [README](../database/README.md) for more information.

### Terraform Backend

See the [parent directory's README](../) for instructions on using a backend for remote state and locking.

### Built Images

The images for Drupal, nginx, and Drush must have been built before this module is deployed. See [How to Run](#how-to-run) for more information.

## Module Inputs

This module expects inputs from two sources: Terraform variables and Parameter Store. The values in Parameter Store are not expected to change often (if at all), and are kept here (instead of in variables) so that they can be generated by build automation rather than having to be manually curated in a `.tfvars` file or script.

### Variables

#### Provider Variables

These variables influence the AWS provider's configuration.

- `aws_region`: This tells the provider which region this module is being deployed in.

#### Deployment Variables

These variables influence the deployment as a whole; generally, they determine the deployment target and some module-global metadata (e.g., AWS resource tags).

- `environment`: The name of the environment being deployed to. The word "environment" here means something like pre-production or production.
- `site`: A string indicating which site in the environment is being deployed to. For example, we may be deploying a `dev` site to the pre-production environment.
- `lang`: Which language (`en` for English, `es` for Spanish) this deployment covers. The template only deploys one site at a time in order to allow for finer-grained deployment logic (e.g., only deploying one language, or deploying both in parallel).
- `tags`: An optional `map(string)` of tags to apply to AWS resources. Useful for cost-tracking tags or resource groups.
- `image_tag`: The build tag for custom images.

#### Drupal Variables

These values customize the Drupal ECS service's behavior. For instance, it determines Drupal's host name(s) and the ECS service capacity.

- `drupal_hostname`: The primary hostname for Drupal. This value is used by Drupal and Drush as the "identity" for its runs: all links are generated based on this hostname. In addition, Traefik uses this for [routing](../infrastructure/README.md#routing).
- `drupal_extra_hostnames`: An optional `list(string)` of additional hostnames that Traefik should allow for routing. This covers use cases such as providing an "origin" host name that can be accessed separately from a caching tier/CDN, or providing VPN-internal addresses. Note that these host names are _not_ provided to Drupal when a request is made.
- `drupal_min_capacity`: The minimum number of ECS tasks to run for Drupal. While this value defaults to 1, production deployments should use a larger value in order to supply high availability even during low-traffic scenarios.
- `drupal_max_capacity`: The maximum number of ECS tasks to run for Drupal. This value is only limited by AWS service quotas (and your budget); plan for low values (e.g., 5) for dev environments and large (e.g., 30 or more) for production-ready deployments. Autoscaling rules will ensure this value is only used when demand requires it.
- `drupal_csrf_origin_whitelist`: This is an optional list of origins provided to [Security Kit](https://www.drupal.org/project/seckit)'s `seckit_csrf.origin_whitelist` configuration. Security Kit checks this list when non-idemptotent (e.g., POST, PUT, DELETE, etc.) requests are sent. If the requesting origin isn't in the list (or is absent entirely), the request is rejected. Note that the value of `var.drupal_hostname` is implicitly added to this list by the module and does not need to be added manually.
- `drupal_state`: This value exists to work around a chicken-and-egg problem when deploying Drupal for the first time. This value _must_ be one of `"run"` or `"build"` or `"migration"`. See the next section for how these influence Drupal's behavior.

##### The `drupal_state` Variable

The `drupal_state` variable deserves special mention. As mentioned above, there is a chicken-and-egg problem when deploying a Drupal site that uses a non-default caching tier. We use memcached as Drupal's caching tier for two reasons: 1) memcached is a much faster caching service, and 2) it reduces load and resource consumption on the database.

However, there is a catch to this. We cannot unconditionally enable the memcached module because, unless Drupal has already been installed, it will attempt to load the memcached code and fail. Thus, we use the `drupal_state` variable to split the site installation and deployment steps.

- When the value of `drupal_state` is `"build"`, the `settings.php` file will not override Drupal's default cache. This allows an administrator to either install Drupal normally or load a database dump.
- When the value is `"run"`, Drupal will be told to use memcached.
- When the value is `"migration"` Drupal will circumvent several workflow automated processes from occurring (automated unpublishing). This was necessary for both running the D7->D8 migration, but is also useful for running the Snapshot as this saves us from using extra resources that aren't necessary.

Note that while it is always safe to keep `drupal_state` in `"build"`, this will cause performance degradation and is **not** recommended for any environment. Once the WebCMS has been installed, set this value to `"run"` and leave it there, except in cicumstances where Drupal needs to be reinstalled or otherwise reinitialized.

##### Sensitive Values

Database connection information is stored in Secrets Manager instead of being provided as plain text variables.

- `/webcms/${var.environment}/${var.site}/${var.lang}/secrets/db-d8-credentials` - A JSON-formatted object of `{ username, password }` containing login credentials for the Drupal 8 database.
- `/webcms/${var.environment}/${var.site}/${var.lang}/secrets/db-d7-credentials` - A JSON-formatted object of `{ username, password }` containing login credentials for the legacy Drupal 7 database. While always set, this is only used in environments where a D7-to-D8 migration is run.

#### Email Variables

These variables influence how Drupal uses SMTP.

- `email_auth_user`: The SMTP username Drupal authenticates as. (The password is provided in Secrets Manager.)
- `email_from`: The "From" address Drupal uses when sending email (e.g., notifications or password resets)
- `email_host`: The SMTP hostname Drupal connects to.
- `email_port`: The SMTP port to connect to. Typical SMTP ports include 25, 456, and 587. There is no default here; please check your SMTP configuration to set here.
- `email_enable_workflow_notifications`: Whether or not to allow workflow notifications. This should be `false` by default; only in production should this be enabled.
- `email_protocol`: How to secure SMTP communication. The value must be one of the following:
  1. `"tls"`, which triggers STARTTLS,
  2. `"ssl"`, which uses SMTPS, or
  3. `"standard"`, which disables encryption. Do not use this value unless your connection to the SMTP server is otherwise private (e.g., over an encrypted tunnel).

##### Sensitive Values

SMTP credentials are saved in Secrets Manager instead of being provided in plain text with Terraform.

- `/webcms/${var.environment}/${var.site}/${var.lang}/mail-password`: The SMTP password.

#### SAML Variables

These variables determine which SAML identity provider (IdP) it connects to, and how it identifies itself to that IdP.

- `saml_sp_entity_id`: The service provider (SP) ID that Drupal uses. Generally, this is `https://${var.drupal_hostname}/saml/metadata`.
- `saml_sp_cert`: The public x509 certificate Drupal uses when communicating with the SAML IdP.
- `saml_idp_id`: The SAML IdP's ID. This is most likely the IdP's metadata URL.
- `saml_idp_sso_url`: The URL of the single sign-on (SSO) endpoint. Drupal will send login requests to this URL.
- `saml_idp_slo_url`: The URL of the single log-out (SLO) endpoint. Drupal will send logout requests to this URL.
- `saml_idp_cert`: The public x509 certificate of the SAML IdP.
- `saml_force_saml_login`: When set to `true`, this disables Drupal login functionality and requires all logins to go through the SAML IdP. The default is `false`, allowing local (i.e., username+password) logins.

##### Sensitive Values

- `/webcms/${var.environment}/${var.site}/${var.lang}/saml-sp-key`: The value of the private key for Drupal's SP certificate. This is the other half of the value `var.saml_sp_cert`.

### Parameter Store

As with the infrastructure and database modules, this module assumes that certain IDs are put into Parameter Store and can be referenced without needing to be set via Terraform's variables mechanism.

- We use a few networking-related parameters to satisfy Fargate's AWSVPC configuration requirements. The [network module](../network) has more information on these.
  - `/webcms/${var.environment}/vpc/private-subnets`: A comma-separated list of VPC subnet IDs (e.g., `subnet-xxxxxxxx,subnet-yyyyyyy`) corresponding to the private subnets.
  - `/webcms/${var.environment}/security-groups/drupal`: Drupal's security group ID (i.e., `sg-xxxxxxx`).
- We use a few service endpoints to inject into the Drupal tasks' configuration:
  - `/webcms/${var.environment}/endpoints/elasticache`: The configuration endpoint used to connect to memcached. Note that this is not the same as the endpoint(s) of a memcached node; see the [AWS docs on autodiscovery](https://docs.aws.amazon.com/AmazonElastiCache/latest/mem-ug/AutoDiscovery.html) for more information.
  - `/webcms/${var.environment}/endpoints/rds-proxy`: The RDS proxy's writer endpoint. Drupal does not connect to the RDS cluster directly, as this prevents effective connection pooling.
  - `/webcms/${var.environment}/endpoints/elasticsearch`: The endpoint for the Elasticsearch cluster.
- We use the ECS cluster name and ARN:
  - `/webcms/${var.environment}/ecs/cluster-name`: The name (e.g., `webcms-preproduction`) of the ECS cluster in this environment.
  - `/webcms/${var.environment}/ecs/cluster-arn`: The full ARN of the ECS cluster in this environment.
- From the ALB we need some ARNs:
  - `/webcms/${var.environment}/alb/listener`: The ARN of the ALB listener responsible for handling connections.
- For Drupal, we load some identifiers for IAM, S3, and the ALB:
  - `/webcms/${var.environment}/${var.site}/${var.lang}/drupal/iam-task`: The ECS task role for Drupal and Drush. This is the run-time IAM role used by the WebCMS and has access to, e.g., S3 and Elasticssearch.
  - `/webcms/${var.environment}/${var.site}/${var.lang}/drupal/iam-execution`: The ECS execution role for Drupal and Drush. This role is used internally by Fargate to launch tasks and thus has access to ECR and Secrets Manager.
  - `/webcms/${var.environment}/${var.site}/${var.lang}/drupal/s3-bucket`: The name of the S3 bucket to store uploaded content.
  - `/webcms/${var.environment}/${var.site}/${var.lang}/drupal/s3-domain`: The full regional domain of the S3 bucket (e.g., `<bucket>.us-east-2.s3.amazonaws.com`).
- Log group identifiers are also read from Parameter Store:
  - `/webcms/${var.environment}/${var.site}/${var.lang}log-groups/php-fpm`: The name of the log group for Drupal's PHP-FPM container.
  - `/webcms/${var.environment}/${var.site}/${var.lang}log-groups/nginx`: The name of the log group for Drupal's nginx container.
  - `/webcms/${var.environment}/${var.site}/${var.lang}log-groups/drush`: The name of the log group for Drush runs.
  - `/webcms/${var.environment}/${var.site}/${var.lang}log-groups/drupal`: The name of the log group for Drupal application logs.
- Finally, Secrets Manager ARNs are read from Parameter Store. More information on how these are used can be read
  - `/webcms/${var.environment}/${var.site}/${var.lang}/secrets/db-d8-credentials`: The ARN of the Drupal 8 login credentials.
  - `/webcms/${var.environment}/${var.site}/${var.lang}/secrets/db-d7-credentials`: The ARN of the legacy Drupal 7 login credentials.
  - `/webcms/${var.environment}/${var.site}/${var.lang}/secrets/drupal-hash-salt`: The ARN of the Drupal hash salt secret.
  - `/webcms/${var.environment}/${var.site}/${var.lang}/secrets/mail-password`: The ARN of the SMTP password.
  - `/webcms/${var.environment}/${var.site}/${var.lang}/secrets/saml-sp-key`: The ARN of the private key for Drupal's SAML certificate.

## Resources

### Drupal

This module creates an ECS task definition and service for running the WebCMS. This task includes a pair of containers, nginx and PHP-FPM, that handle incoming web traffic.

An autoscaling policy is attached to the Drupal service that tracks 60% CPU utilization. Scale-out is more aggressive than scale-in by a factor of five. We enforce slow scale in due to the relatively slow warm-up time of the Drupal containers; a long cooldown smooths out spiky traffic patterns and keeps containers from exhibiting thrashing-like behavior as opcache warms up.

### Drush

This module creates a Drush task definition. The Drush task definition uses the same environment and secrets as Drupal, but instead of being run as an ECS service, the task is instead attached to the EventBridge cron schedule.

### Routing

This module creates an ALB target group and listener rule for Drupal.

## Module Outputs

This module does not have any outputs outside of the resources it creates.

## How to Run

Deployments can be broken down into three steps: build images, apply Terraform, and perform Drush updates.

### Build Images

There are four custom Docker images: Drupal, nginx, and Drush. Depending on the CI/CD infrastructure in play, it can be good to save time by parallelizing the builds. The below shell scripts shows the minimum amount of work necessary to push the images, using the local Docker build cache instead of the ECR-based one:

```sh
#!/bin/bash

set -euo pipefail

# In a CI/CD system, set this based on the branch being built and the build number.
BUILD_TAG="..."

# Build the Drupal target first, tagging it with Drupal ECR repository and $BUILD_TAG.
docker build services/drupal --tag "<drupal repository>:$BUILD_TAG" --target drupal

# Build nginx next, using the same tagging format.
docker build services/drupal --tag "<nginx repository>:$BUILD_TAG" --target nginx

# Finally, Drush.
docker build services/drupal --tag "<drush repository>:$BUILD_TAG" --target drush

docker push "<drupal repository>:$BUILD_TAG"
docker push "<nginx repository>:$BUILD_TAG"
docker push "<drush repository>:$BUILD_TAG"
```

Note that this script does not cover authenticating with ECR or other topics; see the AWS CLI's documentation on authenticating with ECR:

- Recent AWS CLI versions support [`aws ecr get-login-password`](https://awscli.amazonaws.com/v2/documentation/api/latest/reference/ecr/get-login-password.html).
- For older CLI versions, use [`aws ecr get-login`](https://docs.aws.amazon.com/cli/latest/reference/ecr/get-login.html).

### Apply Terraform

1. Configure the backend. See [the relevant section](#terraform-backend) in the prerequisites section above.

   Note that this will most likely require copying a CI/CD-generated file to `terraform/webcms/backend.tf` and calling `terraform init` to allow Terraform to connect to the new backend.

2. Arrange for all Terraform variables to be set. These variables can be set in the environment (in the case of values shared by all branches), set in the CLI, or provided via a `terraform.tfvars` file.

3. Perform one `terraform apply` per site being updated. Generally, we recommend only updating one site per branch, but both languages (English and Spanish).

### Drush Updates

Drush updates are somewhat more involved due to subtle issues with Drupal's caching tiers. If stale Drupal tasks are running at the same time Drush performs its updates, it is possible that the stale tasks will corrupt the shared cache and cause requests to begin failing. This issue is resolved easily by running a Drush task to perform `drush cache-rebuild` (shorthand: `drush cr`) to force Drupal to purge cached data.

Conceptually, there are three steps involved:

1. First, force ECS to delete all stale tasks. This avoids the cache corruption issue mentioned earlier. ECS will launch new Drupal tasks whose caches will be in sync with the pending Drush updates.
2. Construct the necessary JSON-formatted data to run a new Drush task:
   1. Define a container override with a script to perform these steps:
      1. Enable Drupal's maintenance mode. This prevents requests from seeing "in-progress" Drupal schema/configuration updates.
      2. Perform any pending database updates.
      3. Clear caches.
      4. Import new/changed configuration.
      5. Disable maintenance mode.
      6. Clear caches.
   2. Capture the AWSVPC configuration needed by Fargate to launch Drush. At a minimum, this must include the Drupal security group ID and the private subnet ID(s). (If more than one subnet is provided, ECS will choose one.)
3. Use ECS' run task functionality ([`aws ecs run-task`](https://awscli.amazonaws.com/v2/documentation/api/latest/reference/ecs/run-task.html), [`RunTask` API](https://docs.aws.amazon.com/AmazonECS/latest/APIReference/API_RunTask.html)) to spawn a one-off Drush task.

The scripts in [the `ci` directory](../../ci/) can be used as a reference for this part. Since the RunTask API is asynchronous (it returns successfully as soon as the launch request is acknowledged by ECS), the latter portion of the code captures the new task's ARN and waits for its status to change to "STOPPED". If the task did not exit cleanly, then an error is raised to the CI/CD runner.

For more information on the Drush commands issued in these script steps, see:

- The [`state:set` command](https://www.drush.org/latest/commands/state_set/)
- The [`updatedb` command](https://www.drush.org/latest/commands/updatedb/)
- The [`config:import` command](https://www.drush.org/latest/commands/config_import/)

## Post-Run Steps

After the first deployment (or if some values change), some manual steps will need to be taken.

### DNS

Any public hostnames (set via `var.drupal_hostname` and, if set, `var.drupal_extra_hostnames`) will need to be exposed to the internet. For example, if `var.drupal_hostname` is `www.example.com`, then the `www.example.com` record will need to be a CNAME for this environment's network load balancer. This configuration needs to be adjusted for CDN layers.

### Site Installation

In order to access the WebCMS, the site will need to be installed. This can be done by initiating an installation via Drush or by loading a database dump.

When performing a site installation, use the override technique from [the updates section](#drush-updates) and set the script to something like the below:

```sh
drush site:install \
   --yes \
   --account-name=drupalwebcms-admin\
   --existing-config
```

When this task completes, the password will be written to CloudWatch. Use this password to login as `drupalwebcms-admin`, and then reset it. Store this password somewhere safe; it cannot be retrieved. See the [`site:install` command documentation](https://www.drush.org/latest/commands/site_install/) for more information.

### Changing `drupal_state`

Finally, after the site has been loaded (either by installation or from a backup), be sure to change `var.drupal_state` to `"run"`. This tells Drupal it is safe to use memcached instead of the database and will improve site performance.

## Known Issues

- Sometimes, workflow notifications may still be sent to users despite `var.email_enable_workflow_notifications` being set to false. If this occurs, set `var.email_host` to `localhost` (which does not receive SMTP). This will forcibly prevent _all_ messages from being sent, including password resets and other system messages. Ensure you have a way to reset user passwords or do other maintenance tasks that would otherwise be self-service by users.
